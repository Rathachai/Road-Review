<html>
<head>
</head>
<body>
<h1>Rough Road Review: FB</h1>
By: <a href="https://www.linkedin.com/in/rathachai/" target="_blank"><strong>Rathachai Chawuthai</strong></a> 
	<i>Computer Engineering, KMITL</i>
<hr/>
<script src="https://maps.google.com/maps/api/js?sensor=false&key=AIzaSyBPHvA-PSroJj_xgz7j6FQuAQWc77wAoPE"  type="text/javascript"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
<div id="map" style="width: 100%; height: 500px;margin-bottom: 20px"></div>

<script type="text/javascript">

    function getQparam(sParam){
        var sPageURL = window.location.search.substring(1);
        var sURLVariables = sPageURL.split('&');
        for (var i = 0; i < sURLVariables.length; i++) 
        {
            var sParameterName = sURLVariables[i].split('=');
            if (sParameterName[0] == sParam) 
            {
                return sParameterName[1];
            }
        }

        return null;
    }
	
    function genMap(){
          //var threshold = 10;
          var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 17,
                center: {lat: (Math.max.apply(Math,driveData.map(function(a) {return a.lat;}))+Math.min.apply(Math,driveData.map(function(a) {return a.lat;})))/2 , lng: (Math.max.apply(Math,driveData.map(function(a) {return a.lng;}))+Math.min.apply(Math,driveData.map(function(a) {return a.lng;})))/2 } ,//driveData[Math.round(driveData.length/2)],
                mapTypeId: 'terrain'
              });
              var drivePath= new google.maps.Polyline({
                path: driveData,
                geodesic: true,
                strokeColor: '#005500',
                strokeOpacity: 2.0,
                strokeWeight: 3
              });
              drivePath.setMap(map);
      	var driveVal= driveData.map(function(item) { return item["val"]; });
      	driveVal.sort(d3.ascending);
      	//threshold  = d3.quantile(driveVal, 0.99);
        //threshold = 55;
      	for(i=0; i<driveData.length; i++){
      		var di = driveData[i].val;
      		if(Math.abs(di)>threshold){
      			var xcolor = "rgb(" + (Math.abs(Math.round(di))+100)  + ", 0, 0 )";
      			var cityCircle = new google.maps.Circle({
                  			strokeColor: xcolor,
                  			strokeOpacity: 0.8,
                  			strokeWeight: 2,
                  			fillColor: xcolor,
                  			fillOpacity: 0.35,
                  			map: map,
      				center: driveData[i],
                  			radius: Math.sqrt(Math.abs(di))
               		 });
      		}
      	}
    }
    var config = {
      apiKey: " AIzaSyAqeBltX6C5KZ9Y054i_6VGL3n5bbC5NG4",
      authDomain: "rc-iot.firebaseapp.com",
      databaseURL: "https://rc-iot.firebaseio.com",
      storageBucket: "rc-iot.appspot.com"
    };
    firebase.initializeApp(config);
    var driveData = [];
	
    //config
    var device = "rc0018";
    var limitnum = 2200;
    var threshold = 10;

    //get query string
    if(getQparam("dev")!=null){
      device = getQparam("dev");
    }

    if(getQparam("limit")!=null){
      limitnum = parseInt(getQparam("limit"));
    }

    if(getQparam("th")!=null){
      threshold = parseInt(getQparam("th"));
    }
	
    // Qeury data from firebase
    var recentPostsRef = firebase.database().ref(device).limitToLast(limitnum);
	
	
    /*recentPostsRef.on("child_added", function(data){
     var rec = data.val();
     rec.val = rec.gx + rec.gy;
     driveData.push(rec);
    });*/
    recentPostsRef.once('value', snap =>{
      snap.forEach(item => {
          var rec = item.val();
          rec.val = rec.gx + rec.gy;
          driveData.push(rec);
      });
      genMap();
    });
/*
  for(i=0; i<driveData.length; i++){
    var di = driveData[i].lux;
    if(Math.abs(di)<5){
      var xcolor = "#000"; //rgb(" + (Math.abs(Math.round(di))+100)  + ", 0, 0 )";
      var cityCircle = new google.maps.Circle({
                  strokeColor: xcolor,
                  strokeOpacity: 0.2,
                  strokeWeight: 2,
                  fillColor: xcolor,
                  fillOpacity: 0.2,
                  map: map,
        center: driveData[i],
                  radius: 5
             });
    }
  }
*/
</script>
</body>
</html>
